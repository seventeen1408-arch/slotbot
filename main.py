"""
PRO-–±–æ—Ç –¥–ª—è –∞—Ä–±–∏—Ç—Ä–∞–∂–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞.
Production-ready –≤–µ—Ä—Å–∏—è.
"""

import asyncio
import logging
from aiogram import Bot, Dispatcher, types
from aiogram.fsm.storage.memory import MemoryStorage
from apscheduler.schedulers.asyncio import AsyncIOScheduler

from app.core import config, get_logger
from app.database.db import db
from app.services.soft_gate_service import SoftGateService
from app.services.autoresponder_service import AutoResponderService
from app.services.retention_service import RetentionService
from app.services.postback_pro_service import PostbackProService
from app.handlers import start, signals, text_handler, vip_upsell

logger = get_logger(__name__)


async def on_startup(bot: Bot, dispatcher: Dispatcher) -> None:
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞."""
    try:
        logger.info("üöÄ –ó–∞–ø—É—Å–∫ PRO-–±–æ—Ç–∞ –¥–ª—è –∞—Ä–±–∏—Ç—Ä–∞–∂–∞ —Ç—Ä–∞—Ñ–∏–∫–∞...")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î
        await db.init()
        logger.info("‚úÖ –ë–î –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        
        # –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã
        subscription_service = SubscriptionService(bot)
        soft_gate_service = SoftGateService(bot)
        autoresponder_service = AutoResponderService(bot)
        retention_service = RetentionService(bot)
        postback_pro_service = PostbackProService(bot, soft_gate_service=soft_gate_service)
        
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        dispatcher.workflow_data["subscription_service"] = subscription_service
        dispatcher.workflow_data["soft_gate_service"] = soft_gate_service
        dispatcher.workflow_data["autoresponder_service"] = autoresponder_service
        dispatcher.workflow_data["retention_service"] = retention_service
        dispatcher.workflow_data["postback_pro_service"] = postback_pro_service
        
        logger.info("‚úÖ –°–µ—Ä–≤–∏—Å—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
        
        # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
        scheduler = AsyncIOScheduler()
        
        # –ó–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫)
        scheduler.add_job(
            soft_gate_service.check_and_unlock_signals,
            "interval",
            seconds=config.SOFT_GATE_CHECK_INTERVAL,
            id="check_unlock_signals"
        )
        
        scheduler.start()
        dispatcher.workflow_data["scheduler"] = scheduler
        
        logger.info("‚úÖ –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∑–∞–ø—É—â–µ–Ω—ã")
        logger.info("‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}", exc_info=True)
        raise


async def on_shutdown(bot: Bot, dispatcher: Dispatcher) -> None:
    """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞."""
    try:
        logger.info("üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...")
        
        # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
        if "scheduler" in dispatcher.workflow_data:
            scheduler = dispatcher.workflow_data["scheduler"]
            scheduler.shutdown()
            logger.info("‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
        logger.info("‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ: {e}", exc_info=True)


async def main() -> None:
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è."""
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞
        bot = Bot(token=config.BOT_TOKEN)
        storage = MemoryStorage()
        dp = Dispatcher(storage=storage)
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ—É—Ç–µ—Ä—ã
        dp.include_router(start.router)
        dp.include_router(signals.router)
        dp.include_router(text_handler.router)
        dp.include_router(vip_upsell.router)
        
        logger.info("‚úÖ –†–æ—É—Ç–µ—Ä—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
        dp.startup.register(on_startup)
        dp.shutdown.register(on_shutdown)
        
        # –ó–∞–ø—É—Å—Ç–∏—Ç—å polling
        logger.info("üì° –ó–∞–ø—É—Å–∫ polling...")
        await dp.start_polling(
            bot,
            allowed_updates=dp.resolve_used_update_types(),
            skip_updates=True
        )
    
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)
    
    finally:
        logger.info("üõë –ë–æ—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É")


if __name__ == "__main__":
    try:
        # –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        config.validate()
        
        # –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
        asyncio.run(main())
    
    except KeyboardInterrupt:
        logger.info("‚èπÔ∏è –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    
    except Exception as e:
        logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)
