# Auto Funnel Service - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## üìã –û–±–∑–æ—Ä

Auto Funnel Service - —ç—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–≥—Ä–µ–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –≤ VIP.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ 5 —à–∞–≥–æ–≤ –≤–æ—Ä–æ–Ω–∫–∏ (1 –º–∏–Ω, 10 –º–∏–Ω, 60 –º–∏–Ω, 6 —á–∞—Å–æ–≤, 24 —á–∞—Å–∞)
- ‚úÖ Drip-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ + —Ç—Ä–∏–≥–≥–µ—Ä—ã
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ VIP/–¥–µ–ø–æ–∑–∏—Ç
- ‚úÖ –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å (RU/EN)
- ‚úÖ –ê–Ω—Ç–∏—Å–ø–∞–º (1 —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ 30 –º–∏–Ω—É—Ç)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –±–æ—Ç–∞
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥, –±–µ–∑ sleep

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –§–∞–π–ª—ã

```
app/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ funnel_service.py          # FunnelService - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
‚îú‚îÄ‚îÄ scheduler/
‚îÇ   ‚îî‚îÄ‚îÄ funnel_scheduler.py        # FunnelScheduler - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ funnel_config.py           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Ç–µ–∫—Å—Ç—ã, –∫–Ω–æ–ø–∫–∏, —Ç–∞–π–º–∏–Ω–≥–∏)
‚îî‚îÄ‚îÄ database/
    ‚îî‚îÄ‚îÄ models.py                  # –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ User
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **FunnelService** (`app/services/funnel_service.py`)
   - `start_funnel(user_id, user)` - –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–æ–Ω–∫—É
   - `process_user(user)` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
   - `send_step_message(user_id, user, step)` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —à–∞–≥–∞
   - `stop_funnel(user_id, reason)` - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Ä–æ–Ω–∫—É

2. **FunnelScheduler** (`app/scheduler/funnel_scheduler.py`)
   - `start()` - –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
   - `stop()` - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
   - `_check_funnel_events()` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–±—ã—Ç–∏—è (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫)

3. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (`app/config/funnel_config.py`)
   - `FUNNEL_MESSAGES_RU` - —Ä—É—Å—Å–∫–∏–µ —Ç–µ–∫—Å—Ç—ã
   - `FUNNEL_MESSAGES_EN` - –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ç–µ–∫—Å—Ç—ã
   - `FUNNEL_BUTTONS` - –∫–Ω–æ–ø–∫–∏
   - `FUNNEL_TIMINGS` - —Ç–∞–π–º–∏–Ω–≥–∏ —à–∞–≥–æ–≤

---

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main.py

```python
from app.services.funnel_service import FunnelService
from app.scheduler.funnel_scheduler import FunnelScheduler

async def main():
    # ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ ...
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º FunnelService
    funnel_service = FunnelService(
        bot=bot,
        db_service=db_service,
        i18n_service=i18n_service
    )
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º FunnelScheduler
    funnel_scheduler = FunnelScheduler(
        scheduler=scheduler,
        funnel_service=funnel_service,
        db_service=db_service
    )
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
    await funnel_scheduler.start()
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...
    
    try:
        await dp.start_polling(bot)
    finally:
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
        await funnel_scheduler.stop()
        await bot.session.close()
```

---

## üìù –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ handlers

### –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ /start

```python
from app.services.funnel_service import FunnelService

@router.message(Command("start"))
async def start_handler(message: Message, user: User):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Ä–æ–Ω–∫—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await funnel_service.start_funnel(message.from_user.id, user)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    await message.answer("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!")
```

### –ü—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ VIP

```python
# –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫—É–ø–∞–µ—Ç VIP
await funnel_service.stop_funnel(user_id, reason="became_vip")
```

### –ü—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–µ

```python
# –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–µ–ø–∞–ª
await funnel_service.stop_funnel(user_id, reason="deposited")
```

---

## üìä –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –®–∞–≥–∏ –≤–æ—Ä–æ–Ω–∫–∏

| –®–∞–≥ | –ó–∞–¥–µ—Ä–∂–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –¶–µ–ª—å |
|-----|----------|----------|------|
| 0 | 1 –º–∏–Ω | welcome | –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ |
| 1 | 10 –º–∏–Ω | education | –û–±—É—á–µ–Ω–∏–µ (—Å—Ç–∞–≤–∫–∞, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è) |
| 2 | 60 –º–∏–Ω | social_proof | –°–æ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ |
| 3 | 6 —á–∞—Å–æ–≤ | fomo | FOMO (—Å–∏–≥–Ω–∞–ª—ã –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å) |
| 4 | 24 —á–∞—Å–∞ | vip_offer | –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ VIP |

### –£—Å–ª–æ–≤–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

–í–æ—Ä–æ–Ω–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª VIP (`user.vip = true`)
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–µ–ø–∞–ª (`user.is_deposited = true`)
- ‚úÖ –í–æ—Ä–æ–Ω–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (`user.funnel_completed = true`)

### –ê–Ω—Ç–∏—Å–ø–∞–º

- –ú–∏–Ω–∏–º—É–º 30 –º–∏–Ω—É—Ç –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- –ù–µ –±–æ–ª–µ–µ 1 —Å–æ–æ–±—â–µ–Ω–∏—è –≤ 30 –º–∏–Ω—É—Ç

---

## üóÑÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î

### –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ User

```python
funnel_step: int = 0  # –¢–µ–∫—É—â–∏–π —à–∞–≥ (0-5)
funnel_started_at: Optional[int] = None  # –ö–æ–≥–¥–∞ –Ω–∞—á–∞–ª–∞—Å—å (timestamp)
last_funnel_message_at: Optional[int] = None  # –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (timestamp)
is_deposited: bool = False  # –ï—Å—Ç—å –ª–∏ –¥–µ–ø–æ–∑–∏—Ç
funnel_completed: bool = False  # –ó–∞–≤–µ—Ä—à–µ–Ω–∞ –ª–∏
```

### –§—É–Ω–∫—Ü–∏–∏ –ë–î

```python
# –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è –≤–æ—Ä–æ–Ω–∫–∏
await db.update_user_funnel_fields(
    user_id,
    funnel_started_at=now,
    funnel_step=0,
    funnel_completed=False
)

# –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
await db.log_event(
    user_id,
    "funnel_message_sent",
    {"step": 0, "step_name": "welcome"}
)
```

---

## üåç –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å

–¢–µ–∫—Å—Ç—ã –≤–æ—Ä–æ–Ω–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π i18n —Å–µ—Ä–≤–∏—Å:

```python
# –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
text = self.i18n.get("funnel_step_0_welcome", user.language)

# –ü–æ–ª—É—á–∏—Ç—å –∫–Ω–æ–ø–∫—É
btn_text = self.i18n.get("btn_open_signals", user.language)
```

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏: RU, EN

---

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –ë–î:

- `funnel_started` - –≤–æ—Ä–æ–Ω–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞
- `funnel_message_sent` - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
- `funnel_stopped` - –≤–æ—Ä–æ–Ω–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞

–ü—Ä–∏–º–µ—Ä:
```python
await db.log_event(
    user_id,
    "funnel_stopped",
    {"reason": "became_vip"}
)
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç—ã

–†–µ–¥–∞–∫—Ç–∏—Ä—É–π `app/config/funnel_config.py`:

```python
FUNNEL_MESSAGES_RU = {
    "funnel_step_0_welcome": "–¢–≤–æ–π —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å...",
}
```

### –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞–π–º–∏–Ω–≥–∏

```python
FUNNEL_TIMINGS = {
    0: 60,      # 1 –º–∏–Ω—É—Ç–∞
    1: 600,     # 10 –º–∏–Ω—É—Ç
    # ... –∏ —Ç.–¥.
}
```

### –ò–∑–º–µ–Ω–∏—Ç—å –∞–Ω—Ç–∏—Å–ø–∞–º

```python
MIN_MESSAGE_INTERVAL = 1800  # 30 –º–∏–Ω—É—Ç
```

---

## üöÄ Production-ready

- ‚úÖ 100% –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥
- ‚úÖ Type hints –Ω–∞ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –±–æ—Ç–∞
- ‚úÖ –ë–µ–∑ –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é

---

## üìû –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–æ–Ω–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
user = await db.get_user(user_id)
await funnel_service.start_funnel(user_id, user)
```

### –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Ä–æ–Ω–∫—É

```python
await funnel_service.stop_funnel(user_id, reason="became_vip")
```

### –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —à–∞–≥–∞

```python
user = await db.get_user(user_id)
await funnel_service.send_step_message(user_id, user, step=0)
```

---

## üêõ Troubleshooting

### –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –≤–æ—Ä–æ–Ω–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ (`funnel_started_at` –Ω–µ None)
2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –≤–æ—Ä–æ–Ω–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (`funnel_completed` = False)
3. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ (`logs/bot.log`)

### –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ

1. –£–≤–µ–ª–∏—á—å `MIN_MESSAGE_INTERVAL` –≤ `funnel_config.py`
2. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –≤ `funnel_scheduler.py`

### –í–æ—Ä–æ–Ω–∫–∞ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ VIP

1. –£–±–µ–¥–∏—Å—å —á—Ç–æ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ VIP –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `stop_funnel()`
2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ `user.vip = true` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î

---

**–ì–æ—Ç–æ–≤–æ –∫ production! üöÄ**
